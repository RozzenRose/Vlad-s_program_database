#python #память



Python - это язык с автоматическим управлением памятью. Причем для управления ею он использует несколько механизмов. При запуске `Python` программы создается новый #процесс`есть в словаре`, в рамках которого операционная система выделяет пул ресурсов, включая #виртуальное_адресное_пространство. В эту память загружается интерпретатор `Python`
вместе со всеми необходимыми ему для работы данными, включая код нашей программы.

Оставшееся свободная виртуальная память используется для хранения Python объектов. Для управления этой памятью в Python используется специальный механизм, который называется **аллокатор.** Он используется каждый раз, когда нам нужно создать новый объект.

Чаще всего программы не оперируют большими объектами, Большая часть данных - это числа, строки, и т.д., они занимают не такой уж большой объем в расчете не одно значение. о зато мы создаем их достаточно часто. И это приводило бы к проблемам, если бы Python абсолютно все такие вызовы транслировал в операционную систему. Системный вызов на выделение памяти - сравнительно очень долгий процесс, связанный с переходом в контекст ядра операционной системы. Поэтому одна из главных задач аллокатора Python - оптимизация количества системных вызовов.

Для больших объектов Python выделяет память напрямую у ОСи. Обычно таких объектов не очень много в рамках программы, и создаются они нечасто. Поэтому накладные расходы на создание таких объектов напрямую в оперативную память не так высоки.

Аллокатор для малых объектов использует три уровня абстракции:
- блок - кусок памяти, используемый для хранения одного объекта
- пул - кусок памяти, содержащий блок (обычно это одна страница виртуальной памяти 4килобайта)
- арена - большой непрерывный кусок памяти, содержащий пулы (обычно содержит несколько страниц виртуальной памяти и имеет размер 256 килобайт)

![[Pasted image 20240521165002.png]]

#### Блок
это кусок памяти, который может содержать только один Python объект фиксированного размера. Размер блока может варьироваться от 8 до 512 байт и должен быть кратен восьми. Все блоки в конкретном пуле имеют одинаковый размер и находятся в одном классе размера, который и определяет размер блока. Градация в приведенной ниже таблице ниже:
  
|Запрос памяти в байтах|Размер блока в байтах|Индекс класса размера|
|---|---|---|
|1-8|8|0|
|9-16|16|1|
|17-24|24|2|
|25-32|32|3|
|33-40|40|4|
|41-48|48|5|
|...|...|...|
|505-512|512|63|
взята прямо из комментариев в исходном коде
https://github.com/python/cpython/blob/7d6ddb96b34b94c1cbdf95baa94492c48426404e/Objects/obmalloc.c#L603
Таким образом:
- если необходимы 6 байт, то данные будут помещены в блок размером 8 байт.
- если 42 байта, то в блок размером 48 байт
- и т.д.
### Пул