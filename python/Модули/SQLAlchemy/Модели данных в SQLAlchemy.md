#SQLAlchemy 

В **SQLAlchemy** модели представляют собой классы **Python**, которые отображаются на таблицы в базе данных. Они являются основной **ORM** и позволяют взаимодействовать с базой данных через объекты Python, а не через сырые SQL-запросы.

- [[Создание моделей данных в императивном стиле]]
- [[Работа с моделями данных в императивном стиле]]
- [[python/Модули/SQLAlchemy/Декларативный стиль/Создание моделей данных в декларативном стиле|Создание моделей данных в декларативном стиле]]
- [[python/Модули/SQLAlchemy/Декларативный стиль/Работа с моделями данных в декларативном стиле|Работа с моделями данных в декларативном стиле]]

---
**Основные функции моделей SQLAlchemy:**
- **Отображение на таблицы:** Каждая модель SQLAlchemy отображается на конкретную таблицу в базе данных. Атрибуты модели соответствуют столбцам таблицы.
- **Определение структуры таблицы:** В модели определяется структура таблицы: имена столбцов, типы данных, ограничения (например,  `primary_key`,  `unique`,  `nullable`), индексы и др.
- **Взаимодействие с данными:** Через объекты модели вы можете добавлять, изменять, удалять и запрашивать данные из базы данных. SQLAlchemy занимается автоматическим преобразованием данных между форматом Python и форматом базы данных.
- **Управление связями:** Модели позволяют определять связи между таблицами (one-to-one, one-to-many, many-to-many). SQLAlchemy автоматически обрабатывает эти связи при запросах.
- **Валидация данных:** Хотя SQLAlchemy сама по себе не проводит валидацию данных на уровне модели, вы можете использовать дополнительные библиотеки, такие как Pydantic, для добавления валидации в модели.
- **Наследование:** SQLAlchemy поддерживает наследование моделей, позволяя создавать иерархии классов и наследовать свойства от родительских моделей.

---
### Декларативное отображение
Декларативное отображение в **SQLAlchemy** - это подход к определению моделей базы данных, который использует синтаксис, похожий на определение обычных классов **Python**. Он упрощает процесс создания и управления моделями, делая код более читаемым и понятным. Вместо ручного создания таблиц и установки связей через низкоуровневые функции **SQLAlchemy**, вы описываете структуру таблицы внутри класса **Python**.
#### Ключевые элементы декларативного отображения:
- **`Base`:** Это класс, который создает базовый класс для ваших моделей. Все ваши модели будут наследовать от этого базового класса.
- **`__tablename__`:** Атрибут класса модели, указывающий название таблицы в базе данных, которой соответствует эта модель.
- **`Column`:** Класс, который используется для определения столбцов таблицы. Он принимает тип данных столбца (`Integer`,  `String`,  `Boolean`,  `DateTime` и др.) в качестве первого аргумента. Другие параметры могут включать  `primary_key`,  `unique`,  `nullable`,  `default`и др.
- **Типы данных:** SQLAlchemy предоставляет широкий набор типов данных, которые соответствуют типам данных в реляционных базах данных (например,  `Integer`,  `String`, `Float`,  `Boolean`,  `Date`,  `DateTime`).
- **`relationship`:** Функция, которая используется для определения связей между моделями (one-to-one, one-to-many, many-to-many).
#### Преимущества декларативного отображения:
- **Читаемость:** Код становится более читаемым и понятным, поскольку структура таблиц определяется в классах Python.
- **Простота:** Упрощает процесс определения моделей и установки связей.
- **Поддержка IDE:** IDE могут лучше поддерживать автодополнение и другие функции для кода, написанного с использованием декларативного подхода.

Декларативное отображение — это наиболее распространенный и рекомендуемый способ определения моделей в SQLAlchemy, особенно для более сложных приложений. Он значительно упрощает разработку и поддержку базы данных.

В декларативном отображении SQLAlchemy, `mapped_column` — это относительно новый способ определения столбцов таблицы в модели, который появился в SQLAlchemy 2.0. Он предоставляет более питонический и интуитивный синтаксис по сравнению с традиционным использованием `Column`.  `mapped_column` тесно связан с использованием `dataclass` из стандартной библиотеки Python, что делает код более компактным и читаемым.

---
### Императивное отображение
Императивное отображение в **SQLAlchemy** - это подход к созданию таблиц и определению отношений между ними, который использует низкоуровневые функции **SQLAlchemy** напрямую. В отличие от декларативного подхода, где структура таблиц определяется в класса **Python**, в императивном подходе вы строите таблицы "вручную" c помощью объектов `Table` и `MetaData`. Этот подход более гибкий, но и более сложный и трудоемкий.
#### Ключевые элементы императивного отображения:
- **`MetaData`:** Объект `MetaData` хранит информацию о таблицах и их столбцах. Он используется для создания таблиц в базе данных.
- **`Table`:** Объект `Table` представляет таблицу в базе данных. Он создается с помощью `Table(tablename, metadata, Column(...), ...)` и описывает имя таблицы, метаданные и столбцы таблицы.
- **`Column`:** Объект `Column` представляет столбец в таблице. Он принимает тип данных (`Integer`,  `String`,  `Boolean`,  `DateTime` и др.) и другие параметры, такие как `primary_key`,  `unique`,  `nullable` и др.
- **`ForeignKey`:** Используется для определения внешних ключей и связей между таблицами.
- **`ForeignKeyConstraint`:** Для более сложных ограничений внешних ключей.

#### Преимущества императивного подхода:
- **Полный контроль:** Предоставляет максимальный контроль над процессом создания таблиц и установки связей. Полезно для сложных сценариев и специфических требований к базе данных.
- **Гибкость:** Позволяет реализовать более сложные структуры баз данных, чем декларативный подход.
#### Недостатки императивного подхода:
- **Сложность:** Требует большего количества кода и более сложного синтаксиса.
- **Трудоемкость:** Более трудоемкий процесс создания и поддержания моделей.
- **Меньшая читаемость:** Код может быть менее читаемым и понятным, чем декларативный подход.

В большинстве случаев декларативный подход предпочтительнее из-за своей простоты и читаемости. Императивный подход обычно используется только для специфических случаев, когда необходим более тонкий контроль над процессом создания базы данных или когда декларативный подход недостаточно гибок.

---
### Общие параметры столбцов:

Независимо от подхода, вы можете использовать следующие параметры для определения столбцов:
- `primary_key=True`: Указывает, что столбец является первичным ключом.
- `unique=True`: Указывает, что значения в столбце должны быть уникальными.
- `nullable=False`: Указывает, что столбец не может содержать  `NULL` значения (обязательное поле).
- `default=<значение>`: Устанавливает значение по умолчанию для столбца.
- `index=True`: Создает индекс для столбца (ускоряет поиск).
- `autoincrement=True`: Автоматически увеличивает значение столбца (обычно для первичных ключей).
- `check=<выражение>`: Добавляет проверку ограничения на значения в столбце.

Выбор подхода (декларативный или императивный) и конкретных параметров зависит от ваших требований к структуре базы данных и личных предпочтений. Декларативный подход обычно более читаемый и удобен для большинства случаев. Императивный подход дает более тонкий контроль, но требует большего количества кода.

В декларативном подходе SQLAlchemy тип столбца базы данных определяется при определении модели, используя соответствующие типы данных из модуля  `sqlalchemy`. Выбор типа данных зависит от того, какой тип данных вы хотите хранить в столбце и какие операции будете с ними выполнять.

**Основные типы данных и их соответствие в SQLAlchemy:**

|Тип данных SQL|Тип данных SQLAlchemy|Описание|Пример использования|
|---|---|---|---|
|INTEGER|`Integer`|Целое число.|`id = Column(Integer, primary_key=True)`|
|BIGINT|`BigInteger`|Большое целое число.|`user_id = Column(BigInteger)`|
|SMALLINT|`SmallInteger`|Малое целое число.|`order_status = Column(SmallInteger)`|
|VARCHAR(length)|`String(length)`|Строка фиксированной длины.  `length` указывает максимальную длину.|`name = Column(String(255))`|
|TEXT|`Text`|Строка переменной длины.|`description = Column(Text)`|
|BOOLEAN|`Boolean`|Булево значение (True/False).|`is_active = Column(Boolean, default=True)`|
|DATE|`Date`|Дата.|`birthdate = Column(Date)`|
|DATETIME|`DateTime`|Дата и время.|`created_at = Column(DateTime)`|
|TIME|`Time`|Время.|`login_time = Column(Time)`|
|FLOAT|`Float`|Число с плавающей точкой.|`price = Column(Float)`|
|DOUBLE PRECISION|`Float` or `Numeric`|Число с плавающей точкой двойной точности (в зависимости от базы данных).|`latitude = Column(Float), longitude = Column(Float)`|
|DECIMAL(p,s)|`Numeric(precision, scale)`|Десятичное число с заданной точностью (`precision`) и масштабом (`scale`).|`amount = Column(Numeric(10, 2))`|
|JSON|`JSON` or `JSONB`|Данные в формате JSON (тип `JSONB` доступен не во всех базах данных).|`data = Column(JSON)`|
|BLOB|`LargeBinary`|Двоичные данные.|`image = Column(LargeBinary)`|