#FastAPI #Pydantic 

![[Pasted image 20250328162451.png]]
В **FastAPI** тело запросов может быть проверено, чтобы гарантировать отправку только определенных данных. Это крайне важно, чтобы снизить риски вредоносных атак. 

**Pydantic** - это популярная библиотека **Python**, которая используется для валидации данных и парсинга. Она помогает создавать классы данных, которые строго типизировать и автоматически проверяются на соответствие заданным типам и правилам. Это значительно упрощает работу с данными, повышает надежность кода и уменьшает количество ошибок.

**Основные функции Pydantic:**
- **Строгая типизация:** Pydantic использует систему типов Python (type hints) для определения типов данных в классах данных. Это позволяет на ранней стадии обнаруживать ошибки, связанные с несоответствием типов данных.
- **Валидация данных:** Pydantic автоматически валидирует данные при создании объектов класса. Если данные не соответствуют определённым типам или дополнительным правилам (например, ограничения на длину строки, диапазон чисел), Pydantic генерирует информативные сообщения об ошибках.
- **Парсинг данных:** Pydantic легко преобразует данные из различных форматов (например, JSON, dictionaries) в объекты класса. Он автоматически преобразует строки в числа, булевы значения и другие типы данных.
- **Генерация документации:** Pydantic может генерировать документацию для классов данных, описывая все поля, их типы и правила валидации. Это полезно для документации API и других целей.
- **Расширяемость:** Pydantic поддерживает расширение функциональности с помощью настраиваемых валидаторов и преобразователей. Это позволяет добавлять специфические правила валидации для различных ситуаций.
### Модели
Модели создают путем определения подкласса `BaseModel` **Pydantic**. Она выглядит следующим образом:
```python
from pydantic import BaseModel

class Message(BaseModel):
    id: int
    text: str
```
Данная модуль `Message` состоит из двух полей:
- `id`, которое является целым числом,
- `text`, которое является строкой.

В результате данная модель будет представлена следующим образом:
```json
{
	"id": 0,
	"text": "string"
}
```
Мы также, как и в валидации параметров можем устанавливать несколько типов для поля, и также делать поле не обязательным и устанавливать значение по умолчанию:
```python
from pydantic import BaseModel

class Message(BaseModel):
    id: int
    description: str | None = None
    text: str = "Simple text"
```
Поведение полей Pydantic можно настроить с помощью класса `Field()`. Для числовых полей вы можете применить критерии проверки `gt`, `ge`, `lt`, `le`. Чтобы ограничить длину строки, существуют свойства `min_length` и `max_length`: 
- **Общие метаданные**:
	- `title`: описание параметра, отображаемое в документации.
	- `description`: более подробное описание параметра.
	- `example`: пример значения параметра.
	- `include_in_schema`: параметр позволяет исключить исключить операцию пути из сгенерированной схемы **OpenAPI**
-  **Специфичные правила валидации**:
	- `min_length`: минимальная длина строки для параметра.
	- `max_length`: максимальная длина строки для параметра.
	- `pattern`: устанавливает регулярное выражение, которому должно соответствовать значение параметра
	- `lt`: значение должно быть меньше указанного
	- `le`: значение должно быть меньше или равно указанному
	- `gt`: значение должно быть больше указанного
	- `ge`: значение должно быть больше или равно указанному

```python
from pydantic import BaseModel, Field


class Message(BaseModel):
    id: int
    description: str | None = Field(default=None, description="The description of the message", max_length=300)
    text: str = "Simple text"
```
А использование `...` сделает это поле обязательным:
```python
from pydantic import BaseModel, Field


class Message(BaseModel):
    id: int
    description: str = Field(..., description="The description of the message", max_length=300)
    text: str = "Simple text"
```
Если мы работаем с полями даты, и хотим заполнять текущую дату и время автоматически, то можем использовать следующий код:
```python
created: datetime = Field(default_factory=datetime.now)
```
В дополнение к стандартным типам данных Python, библиотека Pydantic определяет свои собственные типы:
- `HttpUrl`: Это поле, по сути, является строкой со встроенной проверкой для URL. Тип HttpUrl принимает как HTTP, так и HTTPS схемы. Он требует указания TLD (домена верхнего уровня) и хоста, максимальная длина 2083 символа.
- `AnyUrl` позволяет использовать любую схему (TLD не требуется, но хост обязателен).
- `FileUrl` предназначено для хранения URL-адреса файла и не требует указания хоста.
- `EmailStr`: Это такая же строка, но которая должна быть действительным адресом электронной почты. Для проверки правильности представления электронной почты в виде строки требует установки модуля `email-validator`.
- `SecretStr`: Этот тип данных используется в основном для хранения паролей или любой другой конфиденциальной информации, которая не должна появляться в логах или другом отслеживании. При преобразовании в JSON он будет отформатирован как '`**********`'.
### Вложенные модели
Модели Pydantic также могут быть вложенными, например, следующие:
```python
from pydantic import BaseModel


class Item(BaseModel):
    description: str | None = None
    text: str = "Simple text"


class Message(BaseModel):
    id: int
    item: Item
```
В результате данные модели будут представлены следующим образом:
```json
{
  "id": 0,
  "item": {
    "description": "string",
    "text": "Simple text"
  }
}
```