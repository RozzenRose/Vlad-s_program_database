#FastAPI #Body

![[Pasted image 20250328140931.png]]
Продолжим разработку нашего проекта, пришло время реализовать функционал для принятия `POST` запросов, с помощью которого мы будем добавлять записи в наше БД(словарь).

Использование метода `GET` для взаимодействия между клиентом и сервером через **HTTP** имеет определенные недостатки. Прежде всего, это не очень безопасно, так как **URL**-адрес вместе с данными параметров виден в адресной строке  браузера. Во-вторых, существует ограничение на то, сколько данных может быть отправлено на сервер вместе с запросом `GET`.

Кроме того, отправляемые данные должны быть представлены только символами `ASCII`. Это означает, что любые двоичные данные, такие как изображение, не могут быть частью запроса `GET`. Чтобы отправить запрос на создание новой записи, протокол **HTTP** требует использования метода `POST`. И данные, необходимые для создания новой записи, упаковываются в тело запроса `POST`.

И у этого есть несколько преимуществ, часть тела запроса не отображается в адресной строке браузера, следовательно, это более безопасный метод. Во-вторых нет ограничения по размеру, и необработанные двоичные данные также могут быть частью тела **HTTP** запроса.

В скелете нашего **API** у нас уже есть функция, которая принимает `POST` запросы, принимая только сам текст записи. Метод мы объявили с помощью декоратора `@app.post`, посмотрим на наш скелет кода:
```python
@app.post("/message")
async def create_message(message: str) -> str:
    return message
```

Обговорим какой функционал нам необходимо реализовать. Первым делом нам нужно получать `id` и записывать в наш словарь текст полученный из `POST` запроса. Также при успешном создании записи, нас нужно установить необходимый код ответа. Коды ответа - это уникальные  короткие коды, выдаваемые сервером в ответ на запрос клиента. Коды состояния ответа сгруппированы в пять категорий, каждая их которых обозначает отдельный ответ:
- **1xx**: запрос получен
- **2xx**: запрос выполнен успешно
- **3xx**: запрос перенаправлен
- **4xx**: ошибка клиента
- **5xx**: ошибка сервера

Полный список кодов состояния **HTTP** можно найти по адресу  [https://www.webfx.com/web-development/glossary/http-status-codes/](https://www.webfx.com/web-development/glossary/http-status-codes/)

Из текста выше видим что декоратор `post` принимает значение `status_code`. В нашем случае нам необходимо установить код `201`, означающий успешное создание. Все статус коды в **FastAPI** мы можем посмотреть в [документации](https://fastapi.tiangolo.com/reference/status/).

Напишем весь этот код, первым делом импортируя модуль `status` из библиотеки `fastapi`:
```python
from fastapi import FastAPI, status

app = FastAPI()

messages_db = {0: "First post in FastAPI"}

@app.post("/message", status_code=status.HTTP_201_CREATED)  
async def create_message(message: str) -> str:  
    messages_db.update({list(messages_db.keys())[-1]+1: message})  
    print(messages_db)  
    return 'Message created!'
```
После заполнения поля `message` и нажатия на кнопку `Execute` мы получим следующий результат:
![[Pasted image 20250328133522.png]]
При этом строка `print(messages_db)` в теле функции `create_message()` выведет текущее состояние словаря `messages_db` в консоль:
![[Pasted image 20250328133733.png]]
Мы получим код ответа `201`, что говорит нам об успешном добавлении записи. Но как мы видим в скриншоте выше, наш текст в `POST` запросе был отправлен не в теле запроса, что видно в следующей команде `curl`:
```http
curl -X 'POST' \
  'http://127.0.0.1:8000/message?message=Second%20post%20in%20FastAPI' \
  -H 'accept: application/json' \
  -d ''
```
И, следовательно, все содержимое запроса видно в **URL** строке. Чтобы упаковать параметр в тело запроса, нам необходимо познакомиться с классом `Body`.
#### Body
Для получения данных из тела запроса можно использовать класс `Body` из пакета `fastapi`. Данный класс позволяет связать с параметром функции-обработчика запроса либо все тело запроса, либо какие-то отдельные его значения. Изменим нашу функцию:
```python
from fastapi import FastAPI, status, Body

app = FastAPI()

messages_db = {0: "First post in FastAPI"}

@app.post("/message", status_code=status.HTTP_201_CREATED)  
async def create_message(message: str = Body()) -> str:  
    messages_db.update({list(messages_db.keys())[-1]+1: message})  
    print(messages_db)  
    return 'Message created!'
```
Запустим приложение. Мы видим что поля с параметрами запросов у нас теперь нет, и документация предлагает передать информацию внутри тела запроса. Попробуем добавить запись. После нажатия кнопки отправки запроса, мы видим, что наше сообщение находится внутри тела запроса:
![[Pasted image 20250328134655.png]]
А в словарь `messages_db` была добавлена запись: 
![[Pasted image 20250328135007.png]]
