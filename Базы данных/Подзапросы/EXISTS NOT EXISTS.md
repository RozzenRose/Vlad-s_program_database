#база_данных #реляционные #SQL #СУБД #подзапросы #any #EXISTS

Таблица, которая будет использована для примера, описана в [[Работа с несколькими таблицами|тут]]

Оператор `EXISTS` проверяет, есть ли записи, удовлетворяющие заданному в подзапросе условию. Если найдется хотя бы одна запись, проверка прервется и оператор `EXISTS` вернет значение `1`, а если нет, то значение `0`
```sql
SELECT author, title
FROM Books
WHERE EXISTS (SELECT *
              FROM BooksRental
              WHERE book_id = Books.id);
```
```
+-----------------+------------------------------------------+
| author          | title                                    |
+-----------------+------------------------------------------+
| J.K. Rowling    | Harry Potter and the Prisoner of Azkaban |
| Chuck Palahniuk | Fight Club                               |
| Stephen King    | The Green Mile                           |
| Stephen King    | It                                       |
+-----------------+------------------------------------------+
```

Например, если основной запрос извлекает следующую запись:
```
+----+-------+--------------+
| id | title | author       |
+----+-------+--------------+
| 4  | It    | Stephen King |
+----+-------+--------------
```
то в подзапросе значение `Books.id` на данный момент равняется `4`, и выполнение подзапроса происходит с учетом именно этого значения. В таблице `BooksRental` есть две записи, у которых значение поля `book_id` равняется `4`:
```
+----+---------+---------+
| id | book_id | user_id |
+----+---------+---------+
| 4  | 4       | 2       |
| 5  | 4       | 1       |
+----+---------+---------+
```
поэтому оператор `EXISTS` вернет значение `1`.

Если основной запрос извлекает следующую запись:
```
+----+----------------+-----------------------+
| id | author         | title                 |
+----+----------------+-----------------------+
| 3  | J.R.R. Tolkien | The Lord of the Rings |
+----+----------------+-----------------------+
```
то в подзапросе значение `Books.id` на данный момент равняется `3`, и выполнение подзапроса происходит с учетом именно этого значения. В таблице `BooksRental` нет ни одной записи, у которой значение поля `book_id` равняется `3`, поэтому оператор `EXISTS` вернет значение `0`.

Обычно в подзапросе оператора `EXISTS` после оператора `SELECT` указывается символ `*`, так как извлечение записей не происходит. Однако мы можем указать любое другое значение, в том числе одно или несколько полей таблицы.

Оператор `EXISTS` является предикатом, то есть его результатом всегда будет значение `0` или `1`. По сути, это обычное условие, которое можно применять совместно с любыми другими условиями, используя операторы `AND` или `OR`.
```sql
SELECT author, title
FROM Books
WHERE author != 'Stephen King' AND EXISTS (SELECT *
                                           FROM BooksRental
                                           WHERE book_id = Books.id);
```
```
+-----------------+------------------------------------------+
| author          | title                                    |
+-----------------+------------------------------------------+
| Chuck Palahniuk | Fight Club                               |
| J.K. Rowling    | Harry Potter and the Prisoner of Azkaban |
+-----------------+------------------------------------------+
```

`NOT EXISTS` делает то же самое, но наоборот

 Главный критерий выбора между операторами `EXISTS` и `IN` – это производительность. Некоррелированный подзапрос может возвращать множество записей, и оператор `IN` будет искать соответствие с каждой из них, что может быть менее эффективно. В отличие от него оператор `EXISTS` проверяет только наличие хотя бы одной записи, не извлекая данные, что делает его более производительным в случаях с большими наборами данных.

Оператор `IN` следует использовать, когда проверяемое значение сравнивается с небольшим фиксированным набором данных, например, при проверке на соответствие одному из нескольких **заранее известных** значений. Оператор `EXISTS` предпочтителен при работе с большими наборами данных, например, когда требуется проверить наличие записей, соответствующих определенным критериям. В таких случаях `EXISTS` позволяет оптимизировать запрос, проверяя наличие хотя бы одной записи, вместо того чтобы извлекать и сравнивать все возможные значения.