#база_данных #реляционные #SQL #СУБД 
##### Таблицы для примеров
**Первая таблица.** Информация об авторах книг располагается в таблице `Authors`, которая имеет следующий вид:
```no-highlight
+----+-----------------+
| id | author          |
+----+-----------------+
| 1  | Stephen King    |
| 2  | Chuck Palahniuk |
| 3  | Jerome Salinger |
+----+-----------------+
```
Первое поле этой таблицы содержит идентификатор автора, второе — имя и фамилию.

**Вторая таблица.** Информация о размещенных в библиотеке книгах располагается в таблице `Books`, которая имеет следующий вид:
```no-highlight
+----+------------------------+-----------+
| id | title                  | author_id |
+----+------------------------+-----------+
| 1  | The Shining            | 1         |
| 2  | Fight Club             | 2         |
| 3  | The Catcher in the Rye | 3         |
| 4  | The Green Mile         | 1         |
| 5  | Haunted                | 2         |
+----+------------------------+-----------+
```
Первое поле этой таблицы содержит идентификатор книги, второе — название, третье — идентификатор автора.

```sql
-- Создание таблицы Authors
DROP TABLE IF EXISTS Authors;
CREATE TABLE Authors
(
    id        INT PRIMARY KEY AUTO_INCREMENT,
    author    VARCHAR(40)
);

INSERT INTO Authors (author)
VALUES ('Stephen King'),
       ('Chuck Palahniuk'),
       ('Jerome Salinger');

-- Создание таблицы Books
DROP TABLE IF EXISTS Books;
CREATE TABLE Books
(
    id        INT PRIMARY KEY AUTO_INCREMENT,
    title     VARCHAR(40),
    author_id INT,
    FOREIGN KEY (author_id) REFERENCES Authors(id)
);

INSERT INTO Books (title, author_id)
VALUES ('The Shining', 1),
       ('Fight Club', 2),
       ('The Catcher in the Rye', 3),
       ('The Green Mile', 1),
       ('Haunted', 2);
```
### Удаление данных
Для удаление данных из таблицы предназначен оператор `DELETE`. Его можно использовать двумя способами:
- для удаления определенных записей
- для удаления всех записей
#### Удаление всех записей
Наиболее простой операцией удаления является удаление абсолютно всех записей таблицы. В качестве примера такой операции рассмотрим запрос, который полностью очищает таблице `Bools`

После выполнения приведенного ниже запроса:
```sql
DELETE FROM Books;
```
таблица `Books` не будет содержать ни одной записи.

Как видно из примера, при написании удаляющего  запроса необходимо указать оператор `DELETE`, а затем ключевое слово `FROM` и название таблицы, из которой должны быть удалены данные

Оператор `DELETE` не требует указания названий полей, потому что он всегда удаляет записи целиком
#### Удаление отдельных записей
Удаление всех записей таблицы требуется крайне редко, и в большинстве случаев оператор `DELETE` используется совместно с оператором `WHERE` для определения условий отбора записей, подлежащих удалению

В качестве примера использования оператора `WHERE` напишем запрос, который удаляет данные о книге под названием `FightClub`
```sql
DELETE FROM Books
WHERE title = 'Fight Club';
```
```
+----+------------------------+-----------+
| id | title                  | author_id |
+----+------------------------+-----------+
| 1  | The Shining            | 1         |
| 3  | The Catcher in the Rye | 3         |
| 4  | The Green Mile         | 1         |
| 5  | Haunted                | 2         |
+----+------------------------+-----------+
```

При удалении данных из одной таблицы допустимо пользоваться данными из других таблиц. Например, мы можем написать запрос, который удаляет данные о всех книгах за авторством `Chuck Palaniuk`

```sql
DELETE FROM Books
WHERE author_id = (SELECT id
                   FROM Authors
                   WHERE author = 'Chuck Palahniuk');
```
```
+----+------------------------+-----------+
| id | title                  | author_id |
+----+------------------------+-----------+
| 1  | The Shining            | 1         |
| 3  | The Catcher in the Rye | 3         |
| 4  | The Green Mile         | 1         |
+----+------------------------+-----------+
```

В примере выше для удаления книг определенного автора используется подзапрос, однако аналогичное удаление может быть выполнено и с помощью соединения. Как и в случае с обновлением записей, соединение при удалении позволяет наделить записи дополнительной информацией и удобно их отфильтровать. Для того чтобы воспользоваться соединением, необходимо после названия таблицы, записи которой требуют удаления, указать ключевое слово `USING`, а затем предоставить выражение, выполняющее соединение

```sql
DELETE FROM Books
USING Books INNER JOIN Authors ON Books.author_id = Authors.id
WHERE Authors.author = 'Chuck Palahniuk';
```
```
+----+------------------------+-----------+
| id | title                  | author_id |
+----+------------------------+-----------+
| 1  | The Shining            | 1         |
| 3  | The Catcher in the Rye | 3         |
| 4  | The Green Mile         | 1         |
+----+------------------------+-----------+
```

Данный запрос функционально повторяет предыдущий запрос и также удаляет данные о всех книгах за авторством `Chuck Palahniuk`. Однако при определении того, нужно удалить запись или нет, запрос использует не исходные записи, а их дополнительные вспомогательной информацией эквиваленты из соединения таблиц `Books` и `Authors`

```
+----+------------------------+-----------+----+-----------------+
| id | title                  | author_id | id | author          |
+----+------------------------+-----------+----+-----------------+
| 1  | The Shining            | 1         | 1  | Stephen King    |
| 4  | The Green Mile         | 1         | 1  | Stephen King    |
| 2  | Fight Club             | 2         | 2  | Chuck Palahniuk |
| 5  | Haunted                | 2         | 2  | Chuck Palahniuk |
| 3  | The Catcher in the Rye | 3         | 3  | Jerome Salinger |
+----+------------------------+-----------+----+-----------------+
```

Если запись в качестве значения поля `author` имеет строку `Chuck Palahniuk`, она удаляется, в противном случае игнорируется
#### Сортировка и ограничение удаляемых записей
При удалении данных допустимо использование операторов `ORDER BY` и `LIMIT` для определения порядка удаления записей и ограничения количества удаляемых записей соответственно. К примеру, сочетание этих операторов позволяет написать запрос, который удаляет данные о самой последней книге
```sql
DELETE FROM Books
ORDER BY id DESC
LIMIT 1;
```
```
+----+------------------------+-----------+
| id | title                  | author_id |
+----+------------------------+-----------+
| 1  | The Shining            | 1         |
| 2  | Fight Club             | 2         |
| 3  | The Catcher in the Rye | 3         |
| 4  | The Green Mile         | 1         |
+----+------------------------+-----------+
```
Данный запрос сортирует записи в порядке убывания значений поля `id` и ограничивает количество удаляемых записей одной записью, что в результате приводит к удалению последней записи таблицы

Оператор `DELETE` удаляет из таблицы отдельные записи или даже все записи за один раз, но он никогда не удаляет саму таблицу
#### Удаление зависимых  данных
Практически всегда база данных состоит из большого количества таблиц, которые определенным образом связаны между собой с помощью внешних ключей. Поэтому закономерно может произойти ситуация, при которой выполняется попытка удаления записи, от значений которой зависят другие записи

Вернемся к рассмотрению нашей базы данных. В таблице `Books` хранятся данные о книгах. Для каждой книги определен собственный  автор, однако подробные данные об этих авторах находятся не в таблице `Books`, а в таблице `Authors`. Сама же таблица `Books` лишь ссылается на эти данные посредством внешнего ключа - поля `author_id`

Теперь предположим, что мы хотим удалить информацию о каком-либо авторе из таблицы `Authors`. Если книги этого автора содержатся в таблице `Books`, то такое удаление может привести к нарушению целостности данных, так как в таблице `Books` будет существовать книга с неизвестным автором

К счастью, при использовании внешних ключей **СУБД** запрещает удаление записей, которые обеспечивают корректность отношений между таблицами, и при попытке выполнить подобное удаление сообщает об ошибке
```sql
DELETE FROM Authors
WHERE author = 'Jerome Salinger';
```
```
ERROR 1451: Cannot delete or update a parent row: a foreign key constraint fails 
```

Запрос выше пытается удалить из таблицы `Authors` запись с данными об авторе `Jerome Salinger`, однако операция завершается с ошибкой, поскольку в таблице `Books`содержится запись, которая ссылается на удаляемые данные

Для того чтобы корректно удалить данные, от которых могут зависеть другие данные, сперва необходимо избавиться от всех потенциальных зависимостей или убедиться, что таких зависимостей нет. В нашем случае для удаления информации об авторе `Jerome Salinger` сначала нужно удалить информацию обо всех принадлежащих ему книгах

После выполнения приведенного ниже запроса:
```sql
DELETE FROM Books
WHERE author_id = (SELECT id
                   FROM Authors
                   WHERE author = 'Jerome Salinger');

DELETE FROM Authors
WHERE author = 'Jerome Salinger';
```
 таблица `Books` будет иметь вид:
```
+----+----------------+-----------+
| id | title          | author_id |
+----+----------------+-----------+
| 1  | The Shining    | 1         |
| 2  | Fight Club     | 2         |
| 4  | The Green Mile | 1         |
| 5  | Haunted        | 2         |
+----+----------------+-----------+
```
таблица `Authors` будет иметь вид:
```
+----+-----------------+
| id | author          |
+----+-----------------+
| 1  | Stephen King    |
| 2  | Chuck Palahniuk |
+----+-----------------+
```

Здесь сперва выполняется обращение к таблице `Books`, из которой удаляются все данные о книгах, автором которых является `Jerome Salinger`, а затем происходит обращение к таблице `Authors`, из которой уде удаляются данные о самом авторе

**СУБД** запрещает удалять зависимые данные только в том, случае, если эти зависимость явно определена. Если между таблицами не существует никакой связи, **СУБД** ну будет следить за целостностью данных в таких таблицах