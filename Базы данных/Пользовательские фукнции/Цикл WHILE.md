#база_данных #реляционные #SQL #СУБД 

Циклы являются неотъемлемой частью практически любого языка программирования. Они позволяют повторять выполнение ряда операций до тех пор, пока истинно определенное условие. В `SQL` реализовано несколько видов циклов, однако мы рассмотрим наиболее важный из них - цикл `WHILE`.

Синтаксис:
```sql
WHILE <проверяемое условие> DO
    <тело цикла>;
END WHILE;
```
Как видно из шаблона, определение цикла начинается с ключевого слова `WHILE`, после которого указывается некоторое условие. Затем следуют ключевое слово `DO` и непосредственно тело цикла. Тело цикла представляет собой одну или несколько операций, выполнение которых и будет повторяться. Завершается определение цикла парой ключевых слов `END WHILE`.

Основная суть цикла `WHILE` заключается в том, что мы задаем некоторое условие и определяем тело цикла. Сначала происходит проверка условия, и если оно истинно, то тело цикла выполняется. Затем происходит повторная проверка условия, и если оно истинно, то тело цикла выполняется снова. Это повторяется до тех пор, пока проверяемое условие истинно. Если во время очередной проверки условие окажется ложным, цикл `WHILE` завершит свою работу.
### Примеры использования цикла WHILE
**Пример 1**. Создадим пользовательскую функцию `CALCULATE_HOURS()` для подсчета количества часов. Функция будет принимать в качестве аргумента количество минут и возвращать целое количество часов, содержащееся в переданном количестве минут.
```sql
DELIMITER //
CREATE FUNCTION CALCULATE_HOURS(minutes INT)
RETURNS INT
DETERMINISTIC
BEGIN
    DECLARE result INT DEFAULT 0;                -- конечное количество часов
   
    WHILE minutes >= 60 DO                       -- проверяем, что количество минут больше или равно 60
        SET result := result + 1;                -- увеличиваем количество часов на единицу
        SET minutes := minutes - 60;             -- уменьшаем количество минут на 60 минут (1 час)
    END WHILE;
   
    RETURN result;
END //
DELIMITER ;

SELECT CALCULATE_HOURS(30),
       CALCULATE_HOURS(60),
       CALCULATE_HOURS(95),
       CALCULATE_HOURS(125);
```
```
+---------------------+---------------------+---------------------+----------------------+
| CALCULATE_HOURS(30) | CALCULATE_HOURS(60) | CALCULATE_HOURS(95) | CALCULATE_HOURS(125) |
+---------------------+---------------------+---------------------+----------------------+
| 0                   | 1                   | 1                   | 2                    |
+---------------------+---------------------+---------------------+----------------------+
```
Тело функции `CALCULATE_HOURS()` начинается с определения переменной `result` со значением `0`, используемой для хранения итогового итогового количества часов. Далее следует цикл `WHILE`, который увеличивает количество часов на единицу и уменьшает количество минут на `60` до тех пор, пока количество минут не окажется меньше `60`. Завершается тело функции возвратом вычисленного количества часов.

**Пример 2**. Создадим пользовательскую функцию `SUM_OF_DIGITS()` для суммирования цифр числа. Функция будет принимать в качестве аргумента неотрицательное целое число и возвращать сумму его цифр.
```sql
DELIMITER //
CREATE FUNCTION SUM_OF_DIGITS(number INT)
RETURNS INT
DETERMINISTIC
BEGIN
    DECLARE result INT DEFAULT 0;                -- конечная сумма
   
    WHILE number > 0 DO                          -- проверяем, что число больше нуля
        SET result := result + number MOD 10;    -- прибавляем последнюю цифру числа
        SET number := number DIV 10;             -- отсекаем последнюю цифру числа
    END WHILE;
   
    RETURN result;
END //
DELIMITER ;

SELECT SUM_OF_DIGITS(7),                        -- 7
       SUM_OF_DIGITS(91),                       -- 9 + 1
       SUM_OF_DIGITS(258),                      -- 2 + 5 + 8
       SUM_OF_DIGITS(2387);                     -- 2 + 3 + 8 + 7
```
```
+------------------+-------------------+--------------------+---------------------+
| SUM_OF_DIGITS(7) | SUM_OF_DIGITS(91) | SUM_OF_DIGITS(258) | SUM_OF_DIGITS(2387) |
+------------------+-------------------+--------------------+---------------------+
| 7                | 10                | 15                 | 20                  |
+------------------+-------------------+--------------------+---------------------+
```

**Пример 3** Создадим пользовательскую функцию `SUM_UP_TO_N()` для суммирования чисел от `1` до `n`. Функция будет принимать в качестве аргумента целое число `n` и возвращать сумму всех целых чисел от `1` до `n` включительно.
```sql
DELIMITER //
CREATE FUNCTION SUM_UP_TO_N(n INT)
RETURNS INT
DETERMINISTIC
BEGIN
    DECLARE result INT DEFAULT 0;                -- конечная сумма
    DECLARE count INT DEFAULT 1;                 -- счетчик
   
    WHILE count <= n DO                          -- проверяем, что счетчик не больше n
        SET result := result + count;            -- прибавляем очередное натуральное число
        SET count := count + 1;                  -- увеличиваем счетчик на единицу
    END WHILE;
   
    RETURN result;
END //
DELIMITER ;

SELECT SUM_UP_TO_N(1),                          -- 1
       SUM_UP_TO_N(2),                          -- 1 + 2
       SUM_UP_TO_N(3),                          -- 1 + 2 + 3
       SUM_UP_TO_N(4),                          -- 1 + 2 + 3 + 4
       SUM_UP_TO_N(5);                          -- 1 + 2 + 3 + 4 + 5
```
```
+----------------+----------------+----------------+----------------+----------------+
| SUM_UP_TO_N(1) | SUM_UP_TO_N(2) | SUM_UP_TO_N(3) | SUM_UP_TO_N(4) | SUM_UP_TO_N(5) |
+----------------+----------------+----------------+----------------+----------------+
| 1              | 3              | 6              | 10             | 15             |
+----------------+----------------+----------------+----------------+----------------+
```

### Примечания
**Примечание 1** `SQL` ориентирован на выполнение запросов, а не на вычисления, поэтому, несмотря на то что язык позволяет реализовывать сложные конструкции с помощью циклов и условий, рекомендуется избегать их применения ради поддержания оптимальной производительности.

**Примечание 2** `WHILE` нельзя использовать вне функции

**Примечание 3** Внутрь цикла `WHILE` можно помещать условную конструкцию `IF-ELSEIF-ELSE`