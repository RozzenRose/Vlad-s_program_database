#база_данных #реляционные #SQL #СУБД #группировка_данных #GROUP_BY #фильтрация_групп 

Данные при извлечении можно не только группировать, но и фильтровать, то есть определять, какие группы должны быть включены в результат запроса, а какие — исключены. К примеру, при извлечении музыкальных исполнителей и суммарного количества прослушиваний их песен нам могут понадобиться лишь те, число прослушиваний которых превышает определенное значение.

Нам уже знаком оператор `WHERE`, однако для фильтрации групп он не подходит, так как его задачей является фильтрация записей при извлечении из таблицы. Для фильтрации групп в SQL используется оператор `HAVING`. В качестве примера использования этого оператора напишем запрос, решающий рассмотренную выше ситуацию по извлечению музыкальных исполнителей, суммарное количество прослушиваний песен которых превышает заданное число.

```sql
SELECT artist,
       SUM(streams) AS streams
FROM Songs
GROUP BY artist
HAVING SUM(streams) > 50000;
```
```
+------------+---------+
| artist     | streams |
+------------+---------+
| Green Day  | 51870   |
| Blondie    | 180184  |
| The Sounds | 208801  |
+------------+---------+
```

Как и прежде, в этом запросе записи сперва группируются по полю `artist`, однако в результирующую таблицу попадают не все группы, а лишь те, сумма значений поля `streams` которых превышает `50000`. Несложно понять, что оператор `WHERE` для подобной фильтрации не подходит, так как данная фильтрация основана на итоговом значении группы, а не на значениях извлеченных из таблицы записей.

Оператор `WHERE` фильтрует записи до того, как данные будут сгруппированы, а оператор `HAVING` — после того, как данные были сгруппированы.

Поскольку операторы `WHERE` и `HAVING` предназначены для разных задач, они могут быть использованы вместе. Примером их совместной работы может быть ситуация, в которой нам необходимо определить исполнителей, которые имеют как минимум две песни с определенным количеством прослушиваний.
```sql
SELECT artist,
       COUNT(*) AS num_of_songs
FROM Songs
WHERE streams > 40000
GROUP BY artist
HAVING COUNT(*) > 1;
```
```
+------------+--------------+
| artist     | num_of_songs |
+------------+--------------+
| Blondie    | 2            |
| The Sounds | 3            |
+------------+--------------+
```
Выполнение данного запроса начинается с извлечения записей, значение поля `streams` которых превышает `40000`. Затем полученные записи группируются по полю `artist`. После выполняется фильтрация сформированных групп путем исключения тех, которые состоят из одной и менее записей. Завершается запрос формированием результирующей таблицы, которая включает поле `artist`, содержащее название исполнителя, и поле `num_of_songs`, содержащее количество песен исполнителя, число прослушиваний которых превышает `40000`.

Оператор `HAVING` следует использовать только вместе с оператором `GROUP BY`, а оператор `WHERE`— для стандартной фильтрации на уровне записей.