#база_данных #реляционные #SQL #СУБД 

##### Таблицы для примеров
**Таблица `Books`**:
```
+----+------------------------+-----------------+-------+
| id | title                  | author          | price |
+----+------------------------+-----------------+-------+
| 1  | The Shining            | Stephen King    | 7.99  |
| 2  | Fight Club             | Chuck Palahniuk | 9.99  |
| 3  | The Catcher in the Rye | J.D. Salinger   | 3.49  |
| 4  | The Green Mile         | Stephen King    | 15.99 |
| 5  | Haunted                | Chuck Palahniuk | 13.99 |
+----+------------------------+-----------------+-------+
```
Первое поле этой таблицы содержит идентификатор книги, второе — название, третье — данные об авторе, четвертое — цену в долларах.
```sql
DROP TABLE IF EXISTS Books;
CREATE TABLE Books
(
    id     INT PRIMARY KEY,
    title  VARCHAR(40),
    author VARCHAR(40),
    price  DECIMAL(10, 2) DEFAULT 0
);

INSERT INTO Books (id, title, author, price)
VALUES (1, 'The Shining', 'Stephen King', 7.99),
       (2, 'Fight Club', 'Chuck Palahniuk', 9.99),
       (3, 'The Catcher in the Rye', 'J.D. Salinger', 3.49),
       (4, 'The Green Mile', 'Stephen King', 15.99),
       (5, 'Haunted', 'Chuck Palahniuk', 13.99);
```
### Добавление данных
Для добавления данных в таблице предназначен оператор `INSERT`. Его можно использовать двумя способами:
- для добавления одной записи
- для добавления нескольких записей
#### Добавление одной записи
Наиболее простым способом применения оператора `INSTERT` является добавление в таблице одной записи. Для этого нужно указать название таблицы, в которую  должна быть добавлена запись, а затем перечислить все значения этой записи

В качестве примера добавления одной записи в таблице рассмотрим запрос, который добавляет в таблице `Books` информацию о книге под названием `Animal Farm` за авторством `George Orwell`
```sql
INSERT INTO Books
VALUES (6, 'Animal Farm', 'George Orwell', NULL);
```
```
+----+------------------------+-----------------+-------+
| id | title                  | author          | price |
+----+------------------------+-----------------+-------+
| 1  | The Shining            | Stephen King    | 7.99  |
| 2  | Fight Club             | Chuck Palahniuk | 9.99  |
| 3  | The Catcher in the Rye | J.D. Salinger   | 3.49  |
| 4  | The Green Mile         | Stephen King    | 15.99 |
| 5  | Haunted                | Chuck Palahniuk | 13.99 |
| 6  | Animal Farm            | George Orwell   | NULL  |
+----+------------------------+-----------------+-------+
```

Запрос выше начинается с оператора `INSERT`, после которого следуют ключевое слово `INTO` и название таблицы, в которую выполняется добавление записи.  Затем используется ключевое слово `VALUES` для указания значений добавляемой записи. Они должны быть заключены в круглые скобки и перечислены через запятую, причем для каждого поля обязательно должно быть указано какое-либо значение. Также при перечислении значений добавляемой записи должен соблюдаться их порядок, поскольку первое значение будет использовано в качестве значения первого поля, второе - в качестве значения второго поля, и так далее.

Если при добавлении записи в таблице для какого-либо ее поля нет соответствующего значения, следует использовать значение `NULL`

Предложенный способ добавления записей в таблице довольно прост, но не вполне безопасен, так как он чувствителен к порядку, в котором поля определены в таблице. Поэтому существует более безопасный способ применения оператора `INSERT`, который требует, чтобы для каждого значения было указано поле, в которое это значение должно быть добавлено
```sql
INSERT INTO Books (id, title, author, price)
VALUES (6, 'Animal Farm', 'George Orwell', NULL);
```
```
+----+------------------------+-----------------+-------+
| id | title                  | author          | price |
+----+------------------------+-----------------+-------+
| 1  | The Shining            | Stephen King    | 7.99  |
| 2  | Fight Club             | Chuck Palahniuk | 9.99  |
| 3  | The Catcher in the Rye | J.D. Salinger   | 3.49  |
| 4  | The Green Mile         | Stephen King    | 15.99 |
| 5  | Haunted                | Chuck Palahniuk | 13.99 |
| 6  | Animal Farm            | George Orwell   | NULL  |
+----+------------------------+-----------------+-------+
```

В данном примере, как и в примере выше, добавляются данные о книге `Animel Farm`, но на этот раз имена полей явно указаны в круглых скобках после имени таблицы. Поэтому, когда запись добавляется в таблицу, **СУБД**  устанавливает соответствие каждого элемента в списке имен полей с соответствующим элементом в списке значений. Первый элемент в списке значений соответствует первому указанному имени поля, второй элемент - второму указанному имени поля, и так далее.

При указании имен полей в явном виде, значения, перечисленные после ключевого слова `VALUES`, должны соответствовать им в том же самом порядке, причем он не обязательно должен совпадать с порядком следования полей в самой таблице
```sql
INSERT INTO Books (id, price, author, title)
VALUES (6, 5.99, 'George Orwell', 'Animal Farm');
```
```
+----+------------------------+-----------------+-------+
| id | title                  | author          | price |
+----+------------------------+-----------------+-------+
| 1  | The Shining            | Stephen King    | 7.99  |
| 2  | Fight Club             | Chuck Palahniuk | 9.99  |
| 3  | The Catcher in the Rye | J.D. Salinger   | 3.49  |
| 4  | The Green Mile         | Stephen King    | 15.99 |
| 5  | Haunted                | Chuck Palahniuk | 13.99 |
| 6  | Animal Farm            | George Orwell   | 5.99  |
+----+------------------------+-----------------+-------+
```
Запрос выше вновь добавляет в таблице `Books` не используется без явного указания имен полей. Благодаря этому значительно возрастает вероятность того, что запрос будет выполнен правильно, даже в таблице произойдут изменения

Как правило, оператор `INSERT` не используется без явного указания имен полей. Благодаря этому значительно возрастает вероятность того, что запрос будет выполнен правильно, даже если в таблице произойдут изменения
#### Добавление нескольких записей
Один запрос с оператором `INSERT` может использоваться как для добавления одной записи, так и нескольких. Если требуется добавить сразу несколько записей, то после ключевого слова `VALUES` необходимо через запятую указать значения для каждой из них

Например, в рамках одного запросе мы можем добавить данные о книге `Animal Farm`, а также дополнительно добавить информацию о книге `Lord of the Flies`
```sql
INSERT INTO Books (id, title, author, price)
VALUES (6, 'Animal Farm', 'George Orwell', NULL),
       (7, 'Lord of the Flies', 'William Golding', 5.99);
```
```
+----+------------------------+-----------------+-------+
| id | title                  | author          | price |
+----+------------------------+-----------------+-------+
| 1  | The Shining            | Stephen King    | 7.99  |
| 2  | Fight Club             | Chuck Palahniuk | 9.99  |
| 3  | The Catcher in the Rye | J.D. Salinger   | 3.49  |
| 4  | The Green Mile         | Stephen King    | 15.99 |
| 5  | Haunted                | Chuck Palahniuk | 13.99 |
| 6  | Animal Farm            | George Orwell   | NULL  |
| 7  | Lord of the Flies      | William Golding | 5.99  |
+----+------------------------+-----------------+-------+
```
#### Добавление вычисляемых значений
В качестве значений добавляемой записи можно использовать не только константные значения, но и результаты арифметических операций, а также возвращаемые значения различных функций

Предположим, нам необходимо добавить информацию о книге `Animal Farm`, цена которой равна `9.99` долларов, однако при добавлении книги ее цену нужно указать со скидкой в `40%`. Для решения такой задачи достаточно умножить исходную цену на `0.6`, что и будет соответствовать требуемой скидке

```sql
INSERT INTO Books (id, title, author, price)
VALUES (6, 'Animal Farm', 'George Orwell', 9.99 * 0.6);
```
```
+----+------------------------+-----------------+-------+
| id | title                  | author          | price |
+----+------------------------+-----------------+-------+
| 1  | The Shining            | Stephen King    | 7.99  |
| 2  | Fight Club             | Chuck Palahniuk | 9.99  |
| 3  | The Catcher in the Rye | J.D. Salinger   | 3.49  |
| 4  | The Green Mile         | Stephen King    | 15.99 |
| 5  | Haunted                | Chuck Palahniuk | 13.99 |
| 6  | Animal Farm            | George Orwell   | 5.99  |
+----+------------------------+-----------------+-------+
```

Также мы можем дополнительно воспользоваться функцией `ROUND()`,  чтобы обнулить дробную часть у цены, полученную после применения скидки.

```sql
INSERT INTO Books (id, title, author, price)
VALUES (6, 'Animal Farm', 'George Orwell', ROUND(9.99 * 0.6));
```
```
+----+------------------------+-----------------+-------+
| id | title                  | author          | price |
+----+------------------------+-----------------+-------+
| 1  | The Shining            | Stephen King    | 7.99  |
| 2  | Fight Club             | Chuck Palahniuk | 9.99  |
| 3  | The Catcher in the Rye | J.D. Salinger   | 3.49  |
| 4  | The Green Mile         | Stephen King    | 15.99 |
| 5  | Haunted                | Chuck Palahniuk | 13.99 |
| 6  | Animal Farm            | George Orwell   | 6.00  |
+----+------------------------+-----------------+-------+
```
#### Добавление с помощью ключевого слова `SET`
Обычно при использовании оператора `INSERT` отдельно указываются поля и отдельно значения, однако существует еще один способ применения этого оператора, при котором поля и их значения располагаются рядом друг с другом и связываются знаком равенства. Синтаксический это очень похоже на использование оператора `UPDATE`, поскольку в данном случае также применяется ключевое слово `SET`
```sql
INSERT INTO Books
SET id = 6,
    title = 'Animal Farm',
    author = 'George Orwell',
    price = 9.99;
```
```
+----+------------------------+-----------------+-------+
| id | title                  | author          | price |
+----+------------------------+-----------------+-------+
| 1  | The Shining            | Stephen King    | 7.99  |
| 2  | Fight Club             | Chuck Palahniuk | 9.99  |
| 3  | The Catcher in the Rye | J.D. Salinger   | 3.49  |
| 4  | The Green Mile         | Stephen King    | 15.99 |
| 5  | Haunted                | Chuck Palahniuk | 13.99 |
| 6  | Animal Farm            | George Orwell   | 9.99  |
+----+------------------------+-----------------+-------+
```

Как видно из примера выше, сперва, как и прежде, мы указываем выражение `INSERT INTO` и название таблицы, в которую выполняется добавление записи, а затем ключевое слово `SET`, после которого определяем значения для каждого поля добавляемой записи.

Сочетание операторов `INSERT` и `SET` позволяет добавить в таблице лишь одну запись
#### Добавление данных из других таблиц
Предположим, в нашей базе данных появилась дополнительная таблица под названием `NewBooks`, которая хранит информацию о двух различных книгах и имеет следующий вид:
```
+----+-------------------+-----------------+-------+
| id | title             | author          | price |
+----+-------------------+-----------------+-------+
| 6  | Animal Farm       | George Orwell   | 9.99  |
| 7  | Lord of the Flies | William Golding | 5.99  | 
+----+-------------------+-----------------+-------+
```
Если нам требуется перенести эту информацию в основную таблицу `Books`, то сделать это можно сочетанием операторов `INSERT` и `SELECT` путем извлечения данных из таблицы `NewBooks` с последующим их добавлением в таблице `Books`
```sql
INSERT INTO Books (id, title, author, price)
SELECT id, title, author, price
FROM NewBooks;
```
```
+----+------------------------+-----------------+-------+
| id | title                  | author          | price |
+----+------------------------+-----------------+-------+
| 1  | The Shining            | Stephen King    | 7.99  |
| 2  | Fight Club             | Chuck Palahniuk | 9.99  |
| 3  | The Catcher in the Rye | J.D. Salinger   | 3.49  |
| 4  | The Green Mile         | Stephen King    | 15.99 |
| 5  | Haunted                | Chuck Palahniuk | 13.99 |
| 6  | Animal Farm            | George Orwell   | 9.99  |
| 7  | Lord of the Flies      | William Golding | 5.99  |
+----+------------------------+-----------------+-------+
```

В данном примере сначала выполняется извлекающий запрос, который возвращает все записи таблицы `NewBooks`. Затем каждая запись добавляется в таблицу `Books`. Важно заметить, что извлекающий запрос должен возвращать таблицу, количество полей которой совпадает с количеством имен полей, указанных после оператора `INSERT`, причем названия полей в возвращаемой извлекающим запросом таблице значения не имеют, так как их сопоставление происходит лишь с учетом порядка

Извлекающий запрос, использует при добавлении данных из других таблиц, является полноценным запросом, поэтому может иметь произвольную сложность

Можно заметить, что в таблице `NewBooks` идентификаторы книг имеют значения `6` и `7`. Сделано это для того, чтобы при переносе записей из таблицы `NewBooks` в таблице `Books` не возникало совпадений между значениями поля `id`, поскольку оно является первичным ключом

Однако на практике первичные ключи могут и будут совпадать, поэтому теперь рассмотрим задачу несколько сложнее, при которой идентификаторы книги в таблице `NewBooks` имеют более привычные значения `1` и `2`:
```
+----+-------------------+-----------------+-------+
| id | title             | author          | price |
+----+-------------------+-----------------+-------+
| 1  | Animal Farm       | George Orwell   | 9.99  |
| 2  | Lord of the Flies | William Golding | 5.99  |
+----+-------------------+-----------------+-------+
```
Если мы вновь попытаемся перенести данные с помощью предыдущего запроса, то столкнемся с ошибкой, поскольку произойдет попытка добавить в таблице `Books` запись, идентификатор которой совпадает с идентификатором уже имеющейся в таблице записи
```sql
INSERT INTO Books (id, title, author, price)
SELECT id, title, author, price
FROM NewBooks;
```
```
ERROR 1062: Duplicate entry '1' for key 'Books.PRIMARY'
```
Для решения данной задачи нам необходимо для каждой добавляемой записи определять новое значение поля `id`. Несложно догадаться, что таким значением является сумма максимального значения поля `id` таблицы `Books` и текущего значения поля `id` добавляемой записи. Максимальное значение поля `id` таблицы `Books` мы можем вычислить с подзапроса, а текущее значение поля `id` добавляемой записи нам доступно и так
```sql
INSERT INTO Books (id, title, author, price)
SELECT (SELECT MAX(id)
        FROM Books) + NewBooks.id,
        title, author, price
FROM NewBooks;
```
```
+----+------------------------+-----------------+-------+
| id | title                  | author          | price |
+----+------------------------+-----------------+-------+
| 1  | The Shining            | Stephen King    | 7.99  |
| 2  | Fight Club             | Chuck Palahniuk | 9.99  |
| 3  | The Catcher in the Rye | J.D. Salinger   | 3.49  |
| 4  | The Green Mile         | Stephen King    | 15.99 |
| 5  | Haunted                | Chuck Palahniuk | 13.99 |
| 6  | Animal Farm            | George Orwell   | 9.99  |
| 7  | Lord of the Flies      | William Golding | 5.99  |
+----+------------------------+-----------------+-------+
```
Здесь, например, первая добавляемая запись в качестве нового значения поля `id` имеет число `6`Ю поскольку максимальным значением поля `id` таблицы `Books` является число `5`Ю а текущим значением поля `id` добавляемой записи является число `1`

Следует заметить, что пример выше является учебным, и на практике явно работать со значениями первичного ключа и следить за их уникальность обычно не нужно, поскольку подобным может заниматься сама **СУБД**. Чаще всего поле, являющееся первичным ключом, определяют как целочисленное и самозаполняющееся. При добавлении первой записи такого поля автоматически принимается равным `1`, при добавлении второй записи - `2`, и так далее. Подробнее об этом будет рассказано в следующем модуле, посвященном созданию таблиц
### Примечание
**Примечание 1**: Если поле имеет значение по умолчанию, то при добавлении записи значение для такого поля, как и само поле можно не указывать. К примеру поле `price ` таблицы `Books` имеет значение по умолчанию равное `0`. Если во время добавления записи мы опустим это поле, то в качестве значения поля `price` будет использовано число `0`
```sql
INSERT INTO Books (id, title, author)
VALUES (6, 'Animal Farm', 'George Orwell');
```
```
+----+------------------------+-----------------+-------+
| id | title                  | author          | price |
+----+------------------------+-----------------+-------+
| 1  | The Shining            | Stephen King    | 7.99  |
| 2  | Fight Club             | Chuck Palahniuk | 9.99  |
| 3  | The Catcher in the Rye | J.D. Salinger   | 3.49  |
| 4  | The Green Mile         | Stephen King    | 15.99 |
| 5  | Haunted                | Chuck Palahniuk | 13.99 |
| 6  | Animal Farm            | George Orwell   | 0.00  |
+----+------------------------+-----------------+-------+
```

**Примечание 2**: Оператор `INSERT` поддерживает дополнительное ключевое слово `IGNORE`, которое позволяет не прерывать процесс добавления данных даже при возникновении ошибок. Например, если выполняется попытка добавления записи, значение первичного ключа которой совпадает со значением первичного ключа уже имеющейся в таблице записи, такая операция просто игнорируется.
```sql
INSERT IGNORE INTO Books (id, title, author, price)
VALUES (1, 'Animal Farm', 'George Orwell', 9.99),
       (6, 'Lord of the Flies', 'William Golding', 5.99);
```
```
+----+------------------------+-----------------+-------+
| id | title                  | author          | price |
+----+------------------------+-----------------+-------+
| 1  | The Shining            | Stephen King    | 7.99  |
| 2  | Fight Club             | Chuck Palahniuk | 9.99  |
| 3  | The Catcher in the Rye | J.D. Salinger   | 3.49  |
| 4  | The Green Mile         | Stephen King    | 15.99 |
| 5  | Haunted                | Chuck Palahniuk | 13.99 |
| 6  | Lord of the Flies      | William Golding | 5.99  |
+----+------------------------+-----------------+-------+
```
Во врем выполнения запроса выше игнорируется добавление первой записи, потому что в таблице `Books` уже имеется книга с идентификатором `1`

**Примечание 3**: В SQL существует оператор `REPLACE`, который работает как `INSERT` и `UPDATE` одновременно: запись добавляется в таблице, если значение ее первичного ключа уникально. Если же оно совпадает со значением первичного ключа другой записи, то добавляемая запись заменяет эту другую запись
```sql
REPLACE INTO Books (id, title, author, price)
VALUES (1, 'Animal Farm', 'George Orwell', 9.99),
       (6, 'Lord of the Flies', 'William Golding', 5.99);
```
```
+----+------------------------+-----------------+-------+
| id | title                  | author          | price |
+----+------------------------+-----------------+-------+
| 1  | Animal Farm            | George Orwell   | 9.99  |
| 2  | Fight Club             | Chuck Palahniuk | 9.99  |
| 3  | The Catcher in the Rye | J.D. Salinger   | 3.49  |
| 4  | The Green Mile         | Stephen King    | 15.99 |
| 5  | Haunted                | Chuck Palahniuk | 13.99 |
| 6  | Lord of the Flies      | William Golding | 5.99  |
+----+------------------------+-----------------+-------+
```
В данном примере из двух записей в таблицу `Books` добавляется только вторая, в то время как первая добавляемая запись заменяет первую запись таблицы, так как их  значения первичного ключа совпадают