#база_данных #реляционные #SQL #СУБД #WITH

##### Таблицы для примера:
Таблица `Moscow`
```
+------------+-------+
| student_id | score |
+------------+-------+
| 1          | 90    |
| 2          | 87    |
| 3          | 88    |
| 4          | 91    |
| 5          | 89    |
| 6          | 92    |
| 7          | 86    |
| 8          | 93    |
| 9          | 85    |
| 10         | 94    |
| 11         | 84    |
| 12         | 95    |
| 13         | 83    |
| 14         | 96    |
| 15         | 82    |
| 16         | 97    |
| 17         | 81    |
| 18         | 98    |
| 19         | 80    |
| 20         | 99    |
+------------+-------+
```

Таблица `SaintPeterburg`
```
+------------+-------+
| student_id | score |
+------------+-------+
| 1          | 89    |
| 2          | 88    |
| 3          | 90    |
| 4          | 87    |
| 5          | 91    |
| 6          | 86    |
| 7          | 92    |
| 8          | 85    |
| 9          | 93    |
| 10         | 84    |
| 11         | 94    |
| 12         | 83    |
| 13         | 95    |
| 14         | 82    |
| 15         | 96    |
| 16         | 81    |
| 17         | 97    |
| 18         | 80    |
| 19         | 98    |
| 20         | 79    |
+------------+-------+
```

### WITH()
Попробуем решить следующую задачу:

В олимпиаде от каждого университета выступает одинаковое количество студентов. Студенты, набравшие на олимпиаде `90` или больше баллов, называются отличниками. Победителем олимпиады становится тот университет, у которого больше отличников. Если оба вуза имеют одинаковое количество отличников, олимпиада завершается ничьей.

Напишите запрос, который определяет результат олимпиады путем извлечения одного из следующих значений:
- `Moscow University`, если победителем является Московский университет
- `Saint Petersburg University`, если победителем является Санкт-Петербургский университет
- `No winner`, если олимпиада завершилась ничьей

Поле с результатом олимпиады должно иметь псевдоним `winner`.

Решение:
```PostgreSQL
WITH moscow_excellents AS (SELECT COUNT(*) AS count FROM "Moscow" WHERE score >= 90),
     spb_excellents AS (SELECT COUNT(*) AS count FROM "SaintPetersburg" WHERE score >= 90)
     
SELECT CASE
    WHEN moscow_excellents.count > spb_excellents.count THEN 'Moscow University'
    WHEN moscow_excellents.count < spb_excellents.count THEN 'Saint Petersburg University'
    ELSE 'No winner'
END AS winner
FROM moscow_excellents, spb_excellents;
```

Оператор `WITH()` позволяет запомнить целые запросы. Очень удобно.
```
+---------------------+ 
| winner              |
+---------------------+ 
| Moscow University   | 
+---------------------+
```